<!DOCTYPE html>
<html lang="en" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My AI To-Do List</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/shepherd.js@10.0.1/dist/css/shepherd.css"/>
    <style>
        :root {
            --bg-color: #e0e5ec;
            --card-shadow-light: #a3b1c6;
            --card-shadow-dark: #ffffff;
            --text-color: #3e5067;
            --text-muted-color: #8a9aaf;
            --accent-color: #3b82f6;
            --break-color: #10b981;
            
            --bg-color-dark: #2c3038;
            --card-shadow-light-dark: #25282e;
            --card-shadow-dark-dark: #333842;
            --text-color-dark: #e0e5ec;
            --text-muted-color-dark: #8a9aaf;
        }
        html { scroll-behavior: smooth; }
        html.dark {
            --bg-color: var(--bg-color-dark);
            --card-shadow-light: var(--card-shadow-light-dark);
            --card-shadow-dark: var(--card-shadow-dark-dark);
            --text-color: var(--text-color-dark);
            --text-muted-color: var(--text-muted-color-dark);
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
        }
        .neumorphic-card {
            background-color: var(--bg-color);
            border-radius: 20px;
            box-shadow: 6px 6px 12px var(--card-shadow-light), -6px -6px 12px var(--card-shadow-dark);
            transition: box-shadow 0.2s ease;
        }
        .neumorphic-card:hover { box-shadow: 4px 4px 8px var(--card-shadow-light), -4px -4px 8px var(--card-shadow-dark); }
        .neumorphic-card:active, .active-press { box-shadow: inset 4px 4px 8px var(--card-shadow-light), inset -4px -4px 8px var(--card-shadow-dark) !important; }
        .neumorphic-inset {
            background-color: var(--bg-color);
            border-radius: 12px;
            box-shadow: inset 4px 4px 8px var(--card-shadow-light), inset -4px -4px 8px var(--card-shadow-dark);
        }
        .task-card.completed .task-text { text-decoration: line-through; color: var(--text-muted-color); }
        @keyframes fadeInDown { from { opacity: 0; transform: translateY(-10px) scale(0.98); } to { opacity: 1; transform: translateY(0) scale(1); } }
        .fade-in-down { animation: fadeInDown 0.4s ease-out forwards; }
        .fab-container { position: fixed; bottom: 30px; right: 30px; z-index: 50; }
        .fab {
            width: 56px; height: 56px;
            background: linear-gradient(145deg, #f0f5fd, #caced4);
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            color: var(--accent-color);
            box-shadow: 6px 6px 12px var(--card-shadow-light), -6px -6px 12px var(--card-shadow-dark);
            cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;
        }
        html.dark .fab { background: linear-gradient(145deg, #30343c, #282c32); }
        .fab-menu {
            position: absolute; bottom: 65px; right: 0;
            display: flex; flex-direction: column-reverse; align-items: flex-end; gap: 12px;
            visibility: hidden; opacity: 0; transform: translateY(15px) scale(0.95);
            transition: all 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        .fab-container.open .fab-menu { visibility: visible; opacity: 1; transform: translateY(0) scale(1); }
        .fab-item { display: flex; align-items: center; gap: 10px; padding: 8px 16px; cursor: pointer; white-space: nowrap; }
        .theme-switch { display: inline-block; height: 24px; position: relative; width: 48px; }
        .theme-switch input { display:none; }
        .slider { bottom: 0; cursor: pointer; left: 0; position: absolute; right: 0; top: 0; transition: .4s; display: flex; justify-content: space-between; align-items: center; padding: 0 4px; }
        .slider:before { background-color: #fff; bottom: 4px; content: ""; height: 16px; left: 4px; position: absolute; transition: .4s; width: 16px; border-radius: 50%; z-index: 1; }
        input:checked + .slider:before { transform: translateX(24px); }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 100; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; }
        .modal-overlay.visible { opacity: 1; visibility: visible; }
        .modal-content { background-color: var(--bg-color); color: var(--text-color); padding: 24px; border-radius: 12px; width: 90%; max-width: 500px; }
        .focus-mode-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--bg-color); z-index: 200; display: flex; align-items: center; justify-content: center; flex-direction: column; opacity: 0; visibility: hidden; transition: 0.3s; }
        .focus-mode-overlay.visible { opacity: 1; visibility: visible; }
        .timer-circle { width: 300px; height: 300px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-direction: column; margin-bottom: 2rem; }
        .timer-display { font-size: 5rem; font-weight: 700; }
        .btn { padding: 0.75rem 2rem; border-radius: 8px; font-weight: 600; cursor: pointer; text-transform: uppercase; }
        .loader { border: 4px solid rgba(255,255,255,0.3); border-top: 4px solid #3b82f6; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="main-content">
        <div class="container mx-auto p-4 sm:p-6 md:p-8 max-w-3xl min-h-screen">
            <header class="flex justify-between items-start mb-8">
                <div>
                    <h1 class="text-3xl sm:text-4xl font-bold flex items-center gap-3">
                        <span id="header-logo" class="p-2 neumorphic-card text-blue-500">AI</span>
                        <span>To-Do List</span>
                    </h1>
                    <p id="greeting" class="text-sm mt-2 text-gray-500"></p>
                </div>
                <div class="flex items-center gap-4">
                    <button id="start-tour-btn" class="p-2 neumorphic-card">
                         <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-500"><circle cx="12" cy="12" r="10"></circle><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
                    </button>
                    <div class="text-right neumorphic-card p-3">
                        <div id="live-clock" class="text-2xl sm:text-3xl font-bold"></div>
                        <div id="current-date" class="text-xs sm:text-sm"></div>
                    </div>
                </div>
            </header>

            <div id="task-input-container" class="mb-8 p-1 rounded-xl neumorphic-card">
                <div class="flex flex-col sm:flex-row items-center gap-3 p-2">
                    <input type="text" id="taskInput" placeholder="Add a new task..." class="flex-grow p-3 border-0 rounded-lg focus:outline-none w-full bg-transparent neumorphic-inset">
                    <div class="flex items-center gap-4">
                        <button id="addTaskBtn" class="font-semibold px-6 py-3 rounded-lg transition duration-300 flex items-center justify-center gap-2 neumorphic-card">
                            <span class="text-blue-500">Add</span>
                        </button>
                        <div id="theme-switcher-container" class="theme-switch-wrapper neumorphic-card p-1 rounded-full">
                             <label class="theme-switch" for="checkbox">
                                <input type="checkbox" id="checkbox" />
                                <div class="slider round neumorphic-inset">
                                    <svg class="sun" xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#f59e0b" stroke-width="2"><circle cx="12" cy="12" r="5"></circle></svg>
                                    <svg class="moon" xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#3b82f6" stroke-width="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
                                </div>
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <main id="taskList" class="space-y-4"></main>
            <div id="emptyState" class="text-center py-16 hidden">
                <h3 class="text-xl font-semibold opacity-50">All clear!</h3>
            </div>
        </div>
        
        <div id="fab-container" class="fab-container">
            <div class="fab-menu">
                <div id="focusModeBtn" class="fab-item neumorphic-card"><span>üéØ Focus</span></div>
                <div id="suggestPlanBtn" class="fab-item neumorphic-card"><span>‚ú® Plan</span></div>
                <div id="breakdownTaskBtn" class="fab-item neumorphic-card"><span>‚ú® Breakdown</span></div>
                <div id="prioritizeTasksBtn" class="fab-item neumorphic-card"><span>‚ú® Prioritize</span></div>
            </div>
            <div id="fab-main" class="fab">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2.69l.34 3.03 3.03.34-3.03.34-.34 3.03-.34-3.03-3.03-.34 3.03-.34.34-3.03z"></path></svg>
            </div>
        </div>
    </div>

    <div id="modal" class="modal-overlay">
        <div class="modal-content neumorphic-card">
            <div class="flex justify-between items-center mb-4">
                <h3 id="modalTitle" class="text-xl font-bold"></h3>
                <button id="closeModalBtn" class="text-2xl">&times;</button>
            </div>
            <div id="modalBody" class="max-h-[60vh] overflow-y-auto"></div>
            <div class="text-right mt-6">
                <button id="closeModalBtn2" class="font-semibold px-4 py-2 rounded-md neumorphic-card">Close</button>
            </div>
        </div>
    </div>
    
    <div id="focus-mode-overlay" class="focus-mode-overlay">
        <h1 class="text-4xl font-bold mb-2">Focus Mode</h1>
        <p id="focus-task-display" class="mb-8"></p>
        <div class="timer-circle neumorphic-card" id="timer-circle">
            <div class="timer-display" id="timer-display">25:00</div>
            <div class="timer-status" id="timer-status">Time to Work!</div>
        </div>
        <div class="flex gap-4">
            <button id="start-btn" class="btn neumorphic-card">Start</button>
            <button id="pause-btn" class="btn neumorphic-card">Pause</button>
            <button id="reset-btn" class="btn neumorphic-card">Reset</button>
        </div>
        <button id="exit-focus-btn" class="mt-12 text-gray-500">&larr; Back</button>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/shepherd.js@10.0.1/dist/js/shepherd.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Global State ---
            let tasks = JSON.parse(localStorage.getItem('tasks')) || [];
            
            // --- Core Elements ---
            const taskInput = document.getElementById('taskInput');
            const addTaskBtn = document.getElementById('addTaskBtn');
            const taskList = document.getElementById('taskList');
            const emptyState = document.getElementById('emptyState');
            const fabContainer = document.getElementById('fab-container');
            const fabMain = document.getElementById('fab-main');
            const modal = document.getElementById('modal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');

            // --- Core Functions (FIXED!) ---
            const saveTasks = () => localStorage.setItem('tasks', JSON.stringify(tasks));

            const renderTasks = () => {
                taskList.innerHTML = '';
                emptyState.style.display = tasks.length === 0 ? 'block' : 'none';

                tasks.forEach(task => {
                    const card = document.createElement('div');
                    card.className = `task-card neumorphic-card flex items-start gap-4 p-4 fade-in-down ${task.completed ? 'completed opacity-60' : ''}`;
                    
                    card.innerHTML = `
                        <input type="checkbox" ${task.completed ? 'checked' : ''} class="mt-1 h-5 w-5 cursor-pointer">
                        <div class="flex-1">
                            <p class="task-text font-medium ${task.completed ? 'line-through text-gray-400' : ''}">${task.text}</p>
                            ${task.priority ? `<span class="text-xs bg-blue-100 text-blue-700 px-2 py-0.5 rounded-full mt-1 inline-block">P${task.priority}</span>` : ''}
                        </div>
                        <div class="flex gap-2">
                             <button class="focus-btn text-green-500">üéØ</button>
                             <button class="delete-btn text-red-500">üóëÔ∏è</button>
                        </div>
                    `;

                    card.querySelector('input').addEventListener('change', () => {
                        task.completed = !task.completed;
                        saveTasks(); renderTasks();
                    });

                    card.querySelector('.delete-btn').addEventListener('click', () => {
                        tasks = tasks.filter(t => t.id !== task.id);
                        saveTasks(); renderTasks();
                    });

                    card.querySelector('.focus-btn').addEventListener('click', () => enterFocusMode(task.id));

                    taskList.appendChild(card);
                });
            };

            // --- Clock & Greeting ---
            const updateClock = () => {
                const now = new Date();
                document.getElementById('live-clock').textContent = now.toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                document.getElementById('current-date').textContent = now.toLocaleDateString('en-IN', { weekday: 'long', day: 'numeric', month: 'long' });
                
                const hr = now.getHours();
                const greet = document.getElementById('greeting');
                if(hr < 12) greet.textContent = "Good morning! What's the plan?";
                else if(hr < 18) greet.textContent = "Good afternoon! Keep it going.";
                else greet.textContent = "Good evening! Plan for tomorrow?";
            };
            setInterval(updateClock, 1000); updateClock();

            // --- AI Backend Logic ---
            async function callGeminiAPI(payload) {
                try {
                    const response = await fetch('/api/ai-handler', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ payload })
                    });
                    if (!response.ok) throw new Error('Server error');
                    return await response.json();
                } catch (e) {
                    showModal("AI Error", "Make sure your GEMINI_API_KEY is set in Vercel!");
                    return null;
                }
            }

            const suggestPlan = async () => {
                const uncompleted = tasks.filter(t => !t.completed);
                if (uncompleted.length < 2) return showModal("Plan", "Add at least 2 tasks first.");
                showModal("AI Plan", "<div class='loader'></div>");
                const list = uncompleted.map(t => `- ${t.text}`).join('\n');
                const res = await callGeminiAPI({ contents: [{ parts: [{ text: `Create a strategy for: ${list}` }] }] });
                if(res) modalBody.innerHTML = `<div class='p-2'>${res.candidates[0].content.parts[0].text.replace(/\n/g, '<br>')}</div>`;
            };

            const breakdownTask = async () => {
                const text = taskInput.value.trim();
                if (!text) return showModal("Breakdown", "Type a big goal in the box first.");
                showModal("Breaking Down", "<div class='loader'></div>");
                const res = await callGeminiAPI({ 
                    contents: [{ parts: [{ text: `Break this into a JSON array of strings: ${text}` }] }],
                    generationConfig: { responseMimeType: "application/json" }
                });
                if(res) {
                    const subtasks = JSON.parse(res.candidates[0].content.parts[0].text);
                    subtasks.forEach(s => tasks.unshift({ id: Date.now() + Math.random(), text: s, completed: false }));
                    saveTasks(); renderTasks(); hideModal(); taskInput.value = '';
                }
            };

            const prioritizeTasks = async () => {
                const uncompleted = tasks.filter(t => !t.completed);
                if (uncompleted.length < 2) return;
                showModal("Prioritizing", "<div class='loader'></div>");
                const res = await callGeminiAPI({
                    contents: [{ parts: [{ text: `Prioritize these as a JSON list: ${JSON.stringify(uncompleted.map(t => t.text))}` }] }],
                    generationConfig: { responseMimeType: "application/json" }
                });
                if(res) {
                    const sorted = JSON.parse(res.candidates[0].content.parts[0].text);
                    tasks.forEach(t => { const idx = sorted.indexOf(t.text); if(idx !== -1) t.priority = idx + 1; });
                    saveTasks(); renderTasks(); hideModal();
                }
            };

            // --- Pomodoro / Focus Mode ---
            let timer; let seconds = 1500;
            const updateTimerDisp = () => {
                const m = Math.floor(seconds / 60); const s = seconds % 60;
                document.getElementById('timer-display').textContent = `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
            };
            const enterFocusMode = (id) => {
                const t = tasks.find(x => x.id === id);
                document.getElementById('focus-task-display').textContent = t ? `Focusing on: ${t.text}` : "Let's focus!";
                document.getElementById('focus-mode-overlay').classList.add('visible');
            };
            document.getElementById('start-btn').onclick = () => {
                if(timer) return;
                timer = setInterval(() => { if(seconds > 0) { seconds--; updateTimerDisp(); } else { clearInterval(timer); alert("Time's up!"); } }, 1000);
            };
            document.getElementById('pause-btn').onclick = () => { clearInterval(timer); timer = null; };
            document.getElementById('reset-btn').onclick = () => { clearInterval(timer); timer = null; seconds = 1500; updateTimerDisp(); };
            document.getElementById('exit-focus-btn').onclick = () => document.getElementById('focus-mode-overlay').classList.remove('visible');

            // --- UI Listeners ---
            fabMain.onclick = () => fabContainer.classList.toggle('open');
            document.getElementById('suggestPlanBtn').onclick = suggestPlan;
            document.getElementById('breakdownTaskBtn').onclick = breakdownTask;
            document.getElementById('prioritizeTasksBtn').onclick = prioritizeTasks;
            document.getElementById('focusModeBtn').onclick = () => enterFocusMode(null);
            
            addTaskBtn.onclick = () => {
                if(taskInput.value.trim()){
                    tasks.unshift({ id: Date.now(), text: taskInput.value.trim(), completed: false });
                    saveTasks(); renderTasks(); taskInput.value = '';
                }
            };

            const showModal = (title, body) => { modalTitle.textContent = title; modalBody.innerHTML = body; modal.classList.add('visible'); };
            const hideModal = () => modal.classList.remove('visible');
            document.getElementById('closeModalBtn').onclick = hideModal;
            document.getElementById('closeModalBtn2').onclick = hideModal;

            // --- Theme Switch ---
            const themeToggle = document.getElementById('checkbox');
            themeToggle.onchange = () => {
                document.documentElement.classList.toggle('dark');
                localStorage.setItem('theme', themeToggle.checked ? 'dark' : 'light');
            };
            if(localStorage.getItem('theme') === 'dark') { themeToggle.checked = true; document.documentElement.classList.add('dark'); }

            // --- Tour ---
            const tour = new Shepherd.Tour({ useModalOverlay: true, defaultStepOptions: { classes: 'neumorphic-card p-4', scrollTo
